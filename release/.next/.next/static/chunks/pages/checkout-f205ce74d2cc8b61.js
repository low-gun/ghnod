(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2222],{5248:function(e,t,o){(window.__NEXT_P=window.__NEXT_P||[]).push(["/checkout",function(){return o(1275)}])},1275:function(e,t,o){"use strict";o.r(t),o.d(t,{default:function(){return CheckoutPage}});var n=o(5893),u=o(7294),i=o(1163),l=o(3504),a=o(5427),r=o(8097);function CheckoutPage(){let e=(0,u.useRef)(!1),t=(0,i.useRouter)(),{itemIds:o,point:s,couponId:c}=t.query,[d,p]=(0,u.useState)(!1),[m,f]=(0,u.useState)(""),[h,g]=(0,u.useState)([]),[y,D]=(0,u.useState)(!1);console.log("\uD83E\uDDEA 초기 isBuyNow 상태:",y);let[_,b]=(0,u.useState)([]),[E,x]=(0,u.useState)(0),[w,j]=(0,u.useState)(null),[v,C]=(0,u.useState)(Number(s)||0),[N,k]=(0,u.useState)("card"),[S,I]=(0,u.useState)(null),[q,P]=(0,u.useState)(!1);(0,u.useEffect)(()=>{console.log("\uD83D\uDD0D [checkout.js] useEffect 진입");let fetchInitial=async()=>{try{console.log("\uD83D\uDE80 fetchInitial 실행됨");let e=await l.ZP.get("/user");console.log("\uD83D\uDCE5 [checkout.js] /user 응답:",e.data),console.log("\uD83E\uDE99 point_balance 타입 확인:",typeof e.data.point_balance,e.data.point_balance),I(e.data),x(e.data.point_balance||0)}catch(e){console.error("❌ 유저 정보 조회 실패",e)}};fetchInitial()},[]),(0,u.useEffect)(()=>{if(!t.isReady)return;let fetchCartItems=async()=>{try{if(t.query.buyNow&&!e.current){var o,n;e.current=!0;let u=decodeURIComponent(t.query.buyNow),i=JSON.parse(u),a=await l.ZP.post("/cart/items?buyNow=1",{schedule_id:i.schedule_id,quantity:i.quantity||1,unit_price:i.unit_price,discount_price:i.discount_price||0,type:"buyNow"}),r=null===(n=a.data)||void 0===n?void 0:null===(o=n.item)||void 0===o?void 0:o.id;if(!r)throw Error("cart_item_id 없음");D(!0),g([{...i,id:r}]),P(!0),t.replace({pathname:t.pathname,query:{itemIds:String(r)}});return}if(t.query.itemIds){D(!1);let e=await l.ZP.get("/cart/items",{params:{ids:t.query.itemIds.split(","),excludeBuyNow:"true"}});g(e.data.items||[]),P(!0);return}f("선택된 상품이 없습니다.")}catch(e){console.error("❌ fetchCartItems 오류:",e),f("상품 불러오기 실패")}};fetchCartItems()},[t.isReady,t.query]),(0,u.useEffect)(()=>{if(!(null==S?void 0:S.coupons)||0===h.length)return;let e=h.reduce((e,t)=>e+t.unit_price*t.quantity,0),t=S.coupons.map(t=>({...t,amount:"fixed"===t.discount_type?Number(t.discount_amount||0):"percent"===t.discount_type?Math.floor(e*Number(t.discount_value||0)/100):0}));console.log("✅ [checkout.js] 계산된 쿠폰 리스트:",t),b(t)},[S,h]),(0,u.useEffect)(()=>{if(!c||0===_.length||0===h.length)return;console.log("\uD83E\uDDE9 쿠폰 자동 적용 시점 진입"),console.log("\uD83E\uDDFE couponId:",c),console.log("\uD83D\uDCA1 availableCoupons:",_),console.log("\uD83E\uDDEE cartItems:",h);let e=_.find(e=>String(e.id)===String(c));if(!e||"number"!=typeof e.amount){console.log("❌ 해당 쿠폰을 찾을 수 없거나 amount 없음:",e);return}console.log("✅ 쿼리 기반 쿠폰 자동 적용:",e,"amount:",e.amount),j({...e,_ts:Date.now()})},[c,_,h]),(0,u.useEffect)(()=>{console.log("\uD83E\uDDFE useEffect - selectedCoupon 변경 감지됨:",w)},[w]);let handleOrder=async()=>{if(console.log("\uD83E\uDDEA [handleOrder] 현재 isBuyNow:",y),!o)return;p(!0),f(""),console.log("\uD83E\uDDEA [handleOrder] buyNow 쿼리값:",t.query.buyNow);let e={cart_item_ids:o.split(",").map(e=>Number(e)),coupon_id:(null==w?void 0:w.id)||null,used_point:v||0,payment_method:N};try{console.log("\uD83D\uDEA8 주문 payload:",e);let o=await l.ZP.post("/orders",e),{order_id:u}=o.data,i=!1;try{await l.ZP.put("/orders/".concat(u)),i=!0}catch(e){var n;console.error("❌ 주문 상태 업데이트 실패:",null===(n=e.response)||void 0===n?void 0:n.data),f("⚠️ 결제는 완료되었으나 주문 상태 업데이트에 실패했습니다.")}i&&t.push("/orders/".concat(u,"/complete"))}catch(e){console.error("❌ 주문 생성 오류:",e),f("❌ 주문 생성에 실패했습니다.")}finally{p(!1)}},R=w&&"number"==typeof w.amount&&!isNaN(w.amount)&&w.amount>0?w.amount:0;return console.log("\uD83E\uDDFE 렌더 직전 selectedCoupon 상태:",w),console.log("\uD83E\uDDFE 계산된 couponDiscount 값:",R),(0,n.jsxs)("div",{style:{padding:20},children:[(0,n.jsx)("h2",{style:{fontSize:"1.2rem",marginBottom:16},children:"주문 확인"}),0===h.length?(0,n.jsx)("p",{style:{textAlign:"center",width:"100%",marginTop:40},children:"선택한 상품을 불러오는 중입니다..."}):(0,n.jsxs)("div",{style:{display:"flex",flexWrap:"wrap",alignItems:"flex-start",gap:24,marginTop:20},children:[(0,n.jsxs)("div",{style:{flex:"1 1 0%",minWidth:0,display:"grid",gridTemplateColumns:1===h.length?"1fr":"repeat(auto-fit, minmax(280px, 1fr))",gap:16},children:[h.filter(e=>e&&"object"==typeof e&&e.schedule_id).map(e=>(0,n.jsx)(a.Z,{item:e,disableActions:!0},e.id)),(0,n.jsxs)("div",{style:{gridColumn:"1 / -1",marginTop:20},children:[(0,n.jsx)("p",{style:{fontSize:13,color:"#555",marginBottom:12},children:"결제 완료 후 수강 안내 메일이 발송됩니다."}),(0,n.jsxs)("div",{style:{border:"1px solid #ddd",borderRadius:6,padding:12,background:"#fafafa"},children:[(0,n.jsx)("strong",{style:{display:"block",marginBottom:8},children:"결제수단"}),(0,n.jsxs)("label",{style:{fontSize:14,display:"block",marginBottom:4},children:[(0,n.jsx)("input",{type:"radio",value:"card",checked:"card"===N,onChange:e=>k(e.target.value),style:{marginRight:6}}),"카드 결제"]}),(0,n.jsxs)("label",{style:{fontSize:14,display:"block"},children:[(0,n.jsx)("input",{type:"radio",value:"bank",checked:"bank"===N,onChange:e=>k(e.target.value),style:{marginRight:6}}),"무통장 입금"]})]})]})]}),(0,n.jsxs)("div",{style:{flex:"0 0 320px",maxWidth:"100%",width:320,alignSelf:"flex-start",position:"sticky",top:100},children:[S&&(0,n.jsxs)("div",{style:{background:"#f9f9f9",border:"1px solid #ddd",borderRadius:6,padding:12,fontSize:14,marginBottom:16},children:[(0,n.jsx)("strong",{children:"주문자:"})," ",S.username||S.email,(0,n.jsx)("br",{}),(0,n.jsx)("strong",{children:"이메일:"})," ",S.email]}),(0,n.jsx)(r.Z,{items:h,couponDiscount:R,pointUsed:v,onCouponChange:e=>{if(console.log("\uD83D\uDCA1 쿠폰 선택됨:",e),!e){j(null);return}if(0===h.length){alert("상품 정보를 불러오는 중입니다. 잠시 후 다시 시도해주세요.");return}let t=h.reduce((e,t)=>e+t.unit_price*t.quantity,0),o="number"==typeof e.amount?e.amount:"fixed"===e.discount_type?Number(e.discount_amount||0):"percent"===e.discount_type?Math.floor(t*Number(e.discount_value||0)/100):0;console.log("✅ 최종 쿠폰 할인 금액:",o),j({...e,amount:o,_ts:Date.now()}),console.log("\uD83E\uDDFE 상태로 저장한 selectedCoupon:",{...e,amount:o})},onPointChange:C,couponList:_.length>0?_:null,maxPoint:"number"==typeof E?E:0,onCheckout:handleOrder,isLoading:d,checkoutMode:!0}),m&&(0,n.jsx)("p",{style:{marginTop:16,color:"red",fontWeight:"bold"},children:m})]})]})]})}}},function(e){e.O(0,[1238,9774,2888,179],function(){return e(e.s=5248)}),_N_E=e.O()}]);